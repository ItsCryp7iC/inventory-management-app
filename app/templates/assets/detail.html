{% extends "base.html" %}

{% block title %}Asset Detail - {{ asset.asset_tag }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">
        {{ asset.asset_tag }} — {{ asset.name }}
    </h1>

    <a href="{{ url_for('assets.list_assets') }}" class="btn btn-outline-secondary btn-sm">
        Back to Assets
    </a>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">General Information</h5>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Sl No. (Record ID):</strong></div>
            <div class="col-md-8">{{ asset.id }}</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Asset Tag:</strong></div>
            <div class="col-md-8">{{ asset.asset_tag }}</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Name:</strong></div>
            <div class="col-md-8">{{ asset.name }}</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Category:</strong></div>
            <div class="col-md-8">
                {{ asset.category.name if asset.category else "-" }}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Sub-Category:</strong></div>
            <div class="col-md-8">
                {{ asset.subcategory.name if asset.subcategory else "-" }}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Location:</strong></div>
            <div class="col-md-8">
                {{ asset.location.name if asset.location else "-" }}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Vendor:</strong></div>
            <div class="col-md-8">
                {% if asset.vendor %}
                    <a href="#vendorModal" data-bs-toggle="modal" data-bs-target="#vendorModal" class="text-decoration-none">
                        {{ asset.vendor.code or asset.vendor.name }} - {{ asset.vendor.name }}
                    </a>
                {% else %}
                    -
                {% endif %}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Status:</strong></div>
            <div class="col-md-8">
                {% set label_map = {
                    "in_stock": "In Stock",
                    "in_use": "In Use",
                    "repair": "Repair",
                    "damaged": "Damaged",
                    "missing": "Missing",
                    "disposed": "Disposed",
                    "retired": "Retired (legacy)",
                    "under_repair": "Under Repair (legacy)"
                } %}
                {% set color_map = {
                    "in_stock": "success",
                    "in_use": "primary",
                    "repair": "warning",
                    "damaged": "danger",
                    "missing": "secondary",
                    "disposed": "dark",
                    "retired": "secondary",
                    "under_repair": "warning"
                } %}
                {% set status_label = label_map.get(asset.status, asset.status) %}
                {% set status_color = color_map.get(asset.status, "secondary") %}
                <span class="badge bg-{{ status_color }}">
                    {{ status_label }}
                </span>
            </div>
        </div>

    </div>
</div>

<div class="row mb-2">
    <div class="col-md-4"><strong>Assigned To:</strong></div>
    <div class="col-md-8">
        {% if asset.assigned_to %}
            {{ asset.assigned_to }}
            {% if asset.assigned_department %}
                <span class="text-muted">({{ asset.assigned_department }})</span>
            {% endif %}
            {% if asset.assigned_email %}
                — <a href="mailto:{{ asset.assigned_email }}">{{ asset.assigned_email }}</a>
            {% endif %}
            {% if asset.assigned_at %}
                <div class="small text-muted">
                    Since {{ asset.assigned_at }}
                </div>
            {% endif %}
        {% else %}
            <span class="text-muted">Not assigned</span>
        {% endif %}
    </div>
</div>


{% if asset.repair_opened_at or asset.status == "repair" %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">Repair Information</h5>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Status:</strong></div>
            <div class="col-md-8">
                {% if asset.status == "repair" %}
                    <span class="badge bg-warning text-dark">Repair</span>
                {% else %}
                    <span class="badge bg-secondary">Not under repair</span>
                {% endif %}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Repair Vendor:</strong></div>
            <div class="col-md-8">{{ asset.repair_vendor or "-" }}</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Reference:</strong></div>
            <div class="col-md-8">{{ asset.repair_reference or "-" }}</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Opened At:</strong></div>
            <div class="col-md-8">{{ asset.repair_opened_at or "-" }}</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Closed At:</strong></div>
            <div class="col-md-8">{{ asset.repair_closed_at or "-" }}</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Repair Cost:</strong></div>
            <div class="col-md-8">{{ asset.repair_cost or "-" }}</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Repair Notes:</strong></div>
            <div class="col-md-8">{{ asset.repair_notes or "-" }}</div>
        </div>
    </div>
</div>
{% endif %}


<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">Purchase Information</h5>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Purchase Date:</strong></div>
            <div class="col-md-8">
                {{ asset.purchase_date or "-" }}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Purchase Cost:</strong></div>
            <div class="col-md-8">
                {{ asset.cost or "-" }}
            </div>
        </div>
    </div>
</div>

{% if asset.notes %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">Notes</h5>
        <p>{{ asset.notes }}</p>
    </div>
</div>
{% endif %}

<!-- Future Hooks -->
<div class="d-flex flex-wrap gap-2">
    <!-- Future features, still disabled -->
    <button class="btn btn-outline-primary btn-sm" disabled>Assign (Coming Soon)</button>
        
    {% if asset.status == "repair" %}
        <a href="{{ url_for('assets.complete_repair', asset_id=asset.id) }}"
        class="btn btn-outline-success btn-sm">
            Complete Repairsd
        </a>
    {% elif asset.status not in ["disposed", "missing"] %}
        <a href="{{ url_for('assets.start_repair', asset_id=asset.id) }}"
        class="btn btn-outline-warning btn-sm">
            Mark as Faulty / Send to Repair
        </a>
    {% endif %}

    
    <a href="{{ url_for('assets.move_asset', asset_id=asset.id) }}"
    class="btn btn-outline-secondary btn-sm">
        Move Asset
    </a>

    <button class="btn btn-outline-info btn-sm" disabled>Movement Log (Coming Soon)</button>

    <!-- Status updates -->
    <form method="post"
          action="{{ url_for('assets.mark_damaged', asset_id=asset.id) }}"
          class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit"
                class="btn btn-outline-danger btn-sm"
                onclick="return confirm('Mark this asset as DAMAGED?');">
            Mark as Damaged
        </button>
    </form>

    <form method="post"
          action="{{ url_for('assets.mark_missing', asset_id=asset.id) }}"
          class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit"
                class="btn btn-outline-secondary btn-sm"
                onclick="return confirm('Mark this asset as MISSING?');">
            Mark as Missing
        </button>
    </form>

    <form method="post"
          action="{{ url_for('assets.dispose_asset', asset_id=asset.id) }}"
          class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit"
                class="btn btn-outline-danger btn-sm"
                onclick="return confirm('Mark this asset as DISPOSED? This is usually final and should be done only after disposal is verified.');">
            Mark as Disposed
        </button>
    </form>
</div>

{% if events %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">Movement & History</h5>

        <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Event</th>
                        <th>Status Change</th>
                        <th>Location Change</th>
                        <th>By</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ev in events %}
                    <tr>
                        <td>{{ ev.created_at }}</td>
                        <td>
                            {% set type_map = {
                                "created": "Created",
                                "assign": "Assigned",
                                "unassign": "Unassigned",
                                "move": "Moved",
                                "dispose": "Disposed",
                                "repair_start": "Repair Started",
                                "repair_end": "Repair Completed",
                                "damaged": "Damaged",
                                "missing": "Missing",
                                "retire": "Retired (legacy)"
                            } %}

                            {{ type_map.get(ev.event_type, ev.event_type) }}
                        </td>

                        <td>
                            {% set status_labels = {
                                "in_stock": "In Stock",
                                "in_use": "In Use",
                                "repair": "Repair",
                                "damaged": "Damaged",
                                "missing": "Missing",
                                "disposed": "Disposed",
                                "retired": "Retired (legacy)",
                                "under_repair": "Under Repair (legacy)"
                            } %}

                            {% set status_colors = {
                                "in_stock": "success",
                                "in_use": "primary",
                                "repair": "warning",
                                "damaged": "danger",
                                "missing": "secondary",
                                "disposed": "dark",
                                "retired": "secondary",
                                "under_repair": "warning"
                            } %}

                            {% if ev.from_status or ev.to_status %}
                                <span class="badge bg-{{ status_colors.get(ev.from_status, 'secondary') }}">
                                    {{ status_labels.get(ev.from_status, ev.from_status or "-") }}
                                </span>
                                →
                                <span class="badge bg-{{ status_colors.get(ev.to_status, 'secondary') }}">
                                    {{ status_labels.get(ev.to_status, ev.to_status or "-") }}
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <td>
                            {% if ev.from_location or ev.to_location %}
                                {{ ev.from_location.name if ev.from_location else "-" }}
                                →
                                {{ ev.to_location.name if ev.to_location else "-" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <!-- NEW: performed by -->
                        <td>
                            {% if ev.performed_by %}
                                {{ ev.performed_by.username }}
                            {% else %}
                                <span class="text-muted">System</span>
                            {% endif %}
                        </td>

                        <!-- notes -->

                        <td style="white-space: pre-line;">
                            {{ ev.note or "-" }}
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}


{% if current_user.is_authenticated and current_user.is_admin %}
<div class="card shadow-sm">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">Actions</h5>

        <div class="d-flex flex-wrap gap-2">

            <!-- Assign / Unassign -->
            {% if asset.status in ["disposed", "missing", "repair", "damaged"] %}
                <div class="text-muted small">
                    Assignment is disabled while asset status is {{ label_map.get(asset.status, asset.status) }}.
                </div>
            {% else %}
                {% if asset.assigned_to %}
                    <form method="post"
                          action="{{ url_for('assets.unassign_asset', asset_id=asset.id) }}"
                          class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit"
                                class="btn btn-outline-primary btn-sm"
                                onclick="return confirm('Unassign this asset and return to stock?');">
                            Unassign Asset
                        </button>
                    </form>
                {% else %}
                    <form method="post"
                          action="{{ url_for('assets.assign_asset', asset_id=asset.id) }}"
                          class="row g-1 align-items-end">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="col-auto">
                            <label class="form-label mb-1 small">Assign To</label>
                            <input type="text" name="assigned_to" class="form-control form-control-sm"
                                   placeholder="Person name" required>
                        </div>
                        <div class="col-auto">
                            <label class="form-label mb-1 small">Department</label>
                            <input type="text" name="assigned_department" class="form-control form-control-sm"
                                   placeholder="Department">
                        </div>
                        <div class="col-auto">
                            <label class="form-label mb-1 small">Email</label>
                            <input type="email" name="assigned_email" class="form-control form-control-sm"
                                   placeholder="email@company.com">
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-outline-primary btn-sm mt-3">
                                Assign Asset
                            </button>
                        </div>
                    </form>
                {% endif %}
            {% endif %}

            <!-- Dispose -->
            <form method="post"
                  action="{{ url_for('assets.dispose_asset', asset_id=asset.id) }}"
                  class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="btn btn-outline-danger btn-sm"
                        onclick="return confirm('Mark this asset as DISPOSED? This is usually final.');">
                    Mark as Disposed
                </button>
            </form>

        </div>
    </div>
</div>
{% else %}
<div class="alert alert-secondary small">
    You have read-only access. Contact an administrator to make changes.
</div>
{% endif %}

{% if asset.vendor %}
<!-- Vendor modal -->
<div class="modal fade" id="vendorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Vendor Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-1"><strong>Code:</strong> {{ asset.vendor.code or "-" }}</p>
                <p class="mb-1"><strong>Name:</strong> {{ asset.vendor.name }}</p>
                <p class="mb-1"><strong>Email:</strong> {{ asset.vendor.contact_email or "-" }}</p>
                <p class="mb-1"><strong>Phone:</strong> {{ asset.vendor.contact_phone or "-" }}</p>
                <p class="mb-1"><strong>Website:</strong>
                    {% if asset.vendor.website %}
                        <a href="{{ asset.vendor.website }}" target="_blank">{{ asset.vendor.website }}</a>
                    {% else %}
                        -
                    {% endif %}
                </p>
                <p class="mb-1"><strong>Address:</strong> {{ asset.vendor.address or "-" }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}



{% endblock %}
