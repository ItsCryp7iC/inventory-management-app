{% extends "base.html" %}

{% block title %}Asset Detail - {{ asset.asset_tag }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">
        {{ asset.asset_tag }} — {{ asset.name }}
    </h1>

    <a href="{{ url_for('assets.list_assets') }}" class="btn btn-outline-secondary btn-sm">
        Back to Assets
    </a>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">General Information</h5>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Asset Tag:</strong></div>
            <div class="col-md-8">{{ asset.asset_tag }}</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Name:</strong></div>
            <div class="col-md-8">{{ asset.name }}</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Category:</strong></div>
            <div class="col-md-8">
                {{ asset.category.name if asset.category else "-" }}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Sub-Category:</strong></div>
            <div class="col-md-8">
                {{ asset.subcategory.name if asset.subcategory else "-" }}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Location:</strong></div>
            <div class="col-md-8">
                {{ asset.location.name if asset.location else "-" }}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Vendor:</strong></div>
            <div class="col-md-8">
                {{ asset.vendor.name if asset.vendor else "-" }}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Status:</strong></div>
            <div class="col-md-8">
                {% set label_map = {
                    "in_use": "In Use",
                    "in_stock": "In Stock",
                    "under_repair": "Under Repair",
                    "retired": "Retired",
                    "disposed": "Disposed"
                } %}
                {% set color_map = {
                    "in_use": "primary",
                    "in_stock": "success",
                    "under_repair": "warning",
                    "retired": "secondary",
                    "disposed": "dark"
                } %}
                {% set status_label = label_map.get(asset.status, asset.status) %}
                {% set status_color = color_map.get(asset.status, "secondary") %}
                <span class="badge bg-{{ status_color }}">
                    {{ status_label }}
                </span>
            </div>
        </div>

    </div>
</div>

<div class="row mb-2">
    <div class="col-md-4"><strong>Assigned To:</strong></div>
    <div class="col-md-8">
        {% if asset.assigned_to %}
            {{ asset.assigned_to }}
            {% if asset.assigned_department %}
                <span class="text-muted">({{ asset.assigned_department }})</span>
            {% endif %}
            {% if asset.assigned_email %}
                — <a href="mailto:{{ asset.assigned_email }}">{{ asset.assigned_email }}</a>
            {% endif %}
            {% if asset.assigned_at %}
                <div class="small text-muted">
                    Since {{ asset.assigned_at }}
                </div>
            {% endif %}
        {% else %}
            <span class="text-muted">Not assigned</span>
        {% endif %}
    </div>
</div>


<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">Purchase Information</h5>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Purchase Date:</strong></div>
            <div class="col-md-8">
                {{ asset.purchase_date or "-" }}
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><strong>Purchase Cost:</strong></div>
            <div class="col-md-8">
                {{ asset.cost or "-" }}
            </div>
        </div>
    </div>
</div>

{% if asset.notes %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">Notes</h5>
        <p>{{ asset.notes }}</p>
    </div>
</div>
{% endif %}

<!-- Future Hooks -->
<div class="d-flex flex-wrap gap-2">
    <!-- Future features, still disabled -->
    <button class="btn btn-outline-primary btn-sm" disabled>Assign (Coming Soon)</button>
    <button class="btn btn-outline-warning btn-sm" disabled>Mark as Faulty (Coming Soon)</button>
    
    <a href="{{ url_for('assets.move_asset', asset_id=asset.id) }}"
    class="btn btn-outline-secondary btn-sm">
        Move Asset
    </a>

    <button class="btn btn-outline-info btn-sm" disabled>Movement Log (Coming Soon)</button>

    <!-- Retire / Dispose are active actions -->
    <form method="post"
          action="{{ url_for('assets.retire_asset', asset_id=asset.id) }}"
          class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit"
                class="btn btn-outline-dark btn-sm"
                onclick="return confirm('Mark this asset as RETIRED? It will no longer be considered active, but will stay in the records.');">
            Mark as Retired
        </button>
    </form>

    <form method="post"
          action="{{ url_for('assets.dispose_asset', asset_id=asset.id) }}"
          class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit"
                class="btn btn-outline-danger btn-sm"
                onclick="return confirm('Mark this asset as DISPOSED? This is usually final and should be done only after disposal is verified.');">
            Mark as Disposed
        </button>
    </form>
</div>

{% if events %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">Movement & History</h5>

        <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
                <thead>
                    <tr>
                        <th>Date / Time</th>
                        <th>Event</th>
                        <th>Status Change</th>
                        <th>Location Change</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ev in events %}
                    <tr>
                        <td>{{ ev.created_at }}</td>
                        <td>{{ ev.event_type }}</td>
                        <td>
                            {% if ev.from_status or ev.to_status %}
                                {{ ev.from_status or "-" }} → {{ ev.to_status or "-" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if ev.from_location_id or ev.to_location_id %}
                                {{ ev.from_location_id or "-" }} → {{ ev.to_location_id or "-" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ ev.note or "-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}


<div class="card shadow-sm">
    <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">Actions</h5>
        <div class="d-flex flex-wrap gap-2">
            <!-- Assign / Unassign -->
            {% if asset.assigned_to %}
                <form method="post"
                      action="{{ url_for('assets.unassign_asset', asset_id=asset.id) }}"
                      class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit"
                            class="btn btn-outline-primary btn-sm"
                            onclick="return confirm('Unassign this asset and return to stock?');">
                        Unassign Asset
                    </button>
                </form>
            {% else %}
                <form method="post"
                      action="{{ url_for('assets.assign_asset', asset_id=asset.id) }}"
                      class="row g-1 align-items-end">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="col-auto">
                        <label class="form-label mb-1 small">Assign To</label>
                        <input type="text" name="assigned_to" class="form-control form-control-sm"
                               placeholder="Person name" required>
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1 small">Department</label>
                        <input type="text" name="assigned_department" class="form-control form-control-sm"
                               placeholder="Department">
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1 small">Email</label>
                        <input type="email" name="assigned_email" class="form-control form-control-sm"
                               placeholder="email@company.com">
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-outline-primary btn-sm mt-3">
                            Assign Asset
                        </button>
                    </div>
                </form>
            {% endif %}

            <!-- Future features (still disabled) -->
            <button class="btn btn-outline-warning btn-sm" disabled>Mark as Faulty (Coming Soon)</button>
            <button class="btn btn-outline-secondary btn-sm" disabled>Transfer (Coming Soon)</button>
            <button class="btn btn-outline-info btn-sm" disabled>Movement Log (Coming Soon)</button>

            <!-- Retire -->
            <form method="post"
                  action="{{ url_for('assets.retire_asset', asset_id=asset.id) }}"
                  class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="btn btn-outline-dark btn-sm"
                        onclick="return confirm('Mark this asset as RETIRED? It will no longer be considered active, but will stay in the records.');">
                    Mark as Retired
                </button>
            </form>

            <!-- Dispose -->
            <form method="post"
                  action="{{ url_for('assets.dispose_asset', asset_id=asset.id) }}"
                  class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="btn btn-outline-danger btn-sm"
                        onclick="return confirm('Mark this asset as DISPOSED? This is usually final and should be done only after disposal is verified.');">
                    Mark as Disposed
                </button>
            </form>
        </div>
    </div>
</div>


{% endblock %}
