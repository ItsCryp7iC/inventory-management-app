{% extends "base.html" %}

{% block title %}Assets - IT Inventory Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Assets</h1>
    <a href="{{ url_for('assets.create_asset') }}" class="btn btn-primary btn-sm">
        Add Asset
    </a>
</div>

<!-- Filters -->
<form method="get" class="card mb-3 shadow-sm">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-12 col-md-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select form-select-sm">
                    {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-12 col-md-3">
                <label class="form-label">Location</label>
                <select name="location_id" class="form-select form-select-sm">
                    <option value="">All locations</option>
                    {% for loc in locations %}
                        <option value="{{ loc.id }}" {% if location_id|int == loc.id %}selected{% endif %}>
                            {{ loc.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-12 col-md-4">
                <label class="form-label">Search</label>
                <input
                    type="text"
                    name="q"
                    value="{{ q }}"
                    class="form-control form-control-sm"
                    placeholder="Search by name, tag, or serial">
            </div>

            <div class="col-12 col-md-2 text-md-end">
                <button type="submit" class="btn btn-sm btn-outline-primary me-1">
                    Apply
                </button>
                <a href="{{ url_for('assets.list_assets') }}" class="btn btn-sm btn-outline-secondary">
                    Reset
                </a>
            </div>
        </div>
    </div>
</form>

<div class="card shadow-sm">
    <div class="card-body">
        {% if assets %}
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead>
                        <tr>
                            {% set dir_toggle = "asc" if direction == "desc" else "desc" %}
                            <th style="width:60px;">Sl No.</th>
                            <th>
                                <a class="text-decoration-none"
                                   href="{{ url_for('assets.list_assets', status=status, location_id=location_id, q=q, sort='asset_tag', dir=dir_toggle if sort=='asset_tag' else 'asc') }}">
                                    Asset Tag
                                </a>
                            </th>
                            <th>
                                <a class="text-decoration-none"
                                   href="{{ url_for('assets.list_assets', status=status, location_id=location_id, q=q, sort='name', dir=dir_toggle if sort=='name' else 'asc') }}">
                                    Name
                                </a>
                            </th>
                            <th>
                                <a class="text-decoration-none"
                                   href="{{ url_for('assets.list_assets', status=status, location_id=location_id, q=q, sort='category', dir=dir_toggle if sort=='category' else 'asc') }}">
                                    Category
                                </a>
                            </th>
                            <th>
                                <a class="text-decoration-none"
                                   href="{{ url_for('assets.list_assets', status=status, location_id=location_id, q=q, sort='subcategory', dir=dir_toggle if sort=='subcategory' else 'asc') }}">
                                    Sub-Category
                                </a>
                            </th>
                            <th>
                                <a class="text-decoration-none"
                                   href="{{ url_for('assets.list_assets', status=status, location_id=location_id, q=q, sort='location', dir=dir_toggle if sort=='location' else 'asc') }}">
                                    Location
                                </a>
                            </th>
                            <th>
                                <a class="text-decoration-none"
                                   href="{{ url_for('assets.list_assets', status=status, location_id=location_id, q=q, sort='status', dir=dir_toggle if sort=='status' else 'asc') }}">
                                    Status
                                </a>
                            </th>
                            <th>
                                <a class="text-decoration-none"
                                   href="{{ url_for('assets.list_assets', status=status, location_id=location_id, q=q, sort='purchase_date', dir=dir_toggle if sort=='purchase_date' else 'asc') }}">
                                    Purchase Date
                                </a>
                            </th>
                            <th>
                                <a class="text-decoration-none"
                                   href="{{ url_for('assets.list_assets', status=status, location_id=location_id, q=q, sort='warranty_expiry_date', dir=dir_toggle if sort=='warranty_expiry_date' else 'asc') }}">
                                    Warranty Expiry
                                </a>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for asset in assets %}
                        <tr>
                            <td class="text-muted">{{ loop.index }}</td>
                            <td>
                                <a href="{{ url_for('assets.asset_detail', asset_id=asset.id) }}" 
                                class="text-decoration-none">
                                    {{ asset.asset_tag }}
                                </a>
                            </td>

                            <td>
                                <a href="{{ url_for('assets.asset_detail', asset_id=asset.id) }}" 
                                class="text-decoration-none">
                                    {{ asset.name }}
                                </a>
                            </td>
                            <td>{{ asset.category.name if asset.category else "-" }}</td>
                            <td>{{ asset.subcategory.name if asset.subcategory else "-" }}</td>
                            <td>{{ asset.location.name if asset.location else "-" }}</td>
                            <td>
                                {% set label_map = {
                                    "in_stock": "In Stock",
                                    "assigned": "Assigned",
                                    "repair": "Repair",
                                    "damaged": "Damaged",
                                    "missing": "Missing",
                                    "disposed": "Disposed",
                                    "retired": "Retired (legacy)",
                                    "under_repair": "Under Repair (legacy)",
                                    "in_use": "Assigned (legacy)"
                                } %}
                                {% set color_map = {
                                    "in_stock": "success",
                                    "assigned": "primary",
                                    "repair": "warning",
                                    "damaged": "danger",
                                    "missing": "secondary",
                                    "disposed": "dark",
                                    "retired": "secondary",
                                    "under_repair": "warning",
                                    "in_use": "primary"
                                } %}
                                {% set status_label = label_map.get(asset.status, asset.status) %}
                                {% set status_color = color_map.get(asset.status, "secondary") %}
                                <span class="badge bg-{{ status_color }}">
                                    {{ status_label }}
                                </span>
                            </td>

                            <td>{{ asset.purchase_date or "-" }}</td>
                            <td>{{ asset.warranty_expiry_date or "-" }}</td>
                            <td>
                                {% if current_user.is_authenticated and current_user.is_admin %}
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('assets.edit_asset', asset_id=asset.id) }}"
                                       class="btn btn-sm btn-outline-primary">
                                        Edit
                                    </a>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModal-{{ asset.id }}">
                                        Delete
                                    </button>
                                </div>
                                {% else %}
                                <span class="text-muted">View</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted mb-0">
                No assets found. Asset creation form will be added next.
            </p>
        {% endif %}
    </div>
</div>

{% if assets %}
    {% for asset in assets %}
    <div class="modal fade" id="deleteModal-{{ asset.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Asset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">
                        Delete asset "{{ asset.name }}" ({{ asset.asset_tag or "No Tag" }})? This action cannot be undone.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" action="{{ url_for('assets.delete_asset', asset_id=asset.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}
{% endblock %}
