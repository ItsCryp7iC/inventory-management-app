{% extends "base.html" %}

{% block title %}New Asset - IT Inventory Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">
        {% if is_edit %}
            Edit Asset #{{ asset.id }}
        {% else %}
            New Asset
        {% endif %}
    </h1>
    <a href="{{ url_for('assets.list_assets') }}" class="btn btn-outline-secondary btn-sm">
        Cancel
    </a>
</div>


<div class="card shadow-sm">
    <div class="card-body">
        <form method="post">
            {{ form.hidden_tag() }}

            <div class="row g-3">
                <div class="col-md-8">
                    <label class="form-label">{{ form.name.label }} <span class="text-danger">*</span></label>
                    {{ form.name(class="form-control", placeholder="e.g. Dell Latitude 5420") }}
                    {% for err in form.name.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-12">
                    <label class="form-label">{{ form.description.label }}</label>
                    {{ form.description(class="form-control", rows="2") }}
                    {% for err in form.description.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">{{ form.serial_number.label }}</label>
                    {{ form.serial_number(class="form-control") }}
                    {% for err in form.serial_number.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">{{ form.status.label }} <span class="text-danger">*</span></label>
                    {{ form.status(class="form-select") }}
                    {% for err in form.status.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">{{ form.location_id.label }}</label>
                    {{ form.location_id(class="form-select") }}
                    {% for err in form.location_id.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">{{ form.category_id.label }}</label>
                    {{ form.category_id(class="form-select", id="category-select") }}
                    {% for err in form.category_id.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">{{ form.subcategory_id.label }}</label>
                    <select name="{{ form.subcategory_id.name }}" id="subcategory-select" class="form-select">
                        <option value="0">--- Select ---</option>
                        {% for sc in subcategory_options %}
                            <option
                                value="{{ sc.id }}"
                                data-category="{{ sc.category_id }}"
                                {% if form.subcategory_id.data == sc.id %}selected{% endif %}
                            >
                                {{ sc.label }}
                            </option>
                        {% endfor %}
                    </select>
                    {% for err in form.subcategory_id.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">{{ form.vendor_id.label }}</label>
                    {{ form.vendor_id(class="form-select") }}
                    {% for err in form.vendor_id.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">Purchase Date / Asset Creation Date</label>
                    {{ form.purchase_date(class="form-control", type="date") }}
                    {% for err in form.purchase_date.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">{{ form.warranty_expiry_date.label }}</label>
                    {{ form.warranty_expiry_date(class="form-control", type="date") }}
                    {% for err in form.warranty_expiry_date.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-md-4">
                    <label class="form-label">{{ form.cost.label }}</label>
                    {{ form.cost(class="form-control", step="0.01") }}
                    {% for err in form.cost.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-12">
                    <label class="form-label">{{ form.notes.label }}</label>
                    {{ form.notes(class="form-control", rows="2") }}
                    {% for err in form.notes.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <div class="col-12 mt-2">
                    <input type="hidden" name="action" id="asset-form-action" value="save">
                    <button type="submit" class="btn btn-primary me-2">
                        {% if is_edit %}
                            Update
                        {% else %}
                            Save
                        {% endif %}
                    </button>
                    {% if not is_edit %}
                    <button type="submit" class="btn btn-outline-primary" data-action="add_new">
                        Save and Add New
                    </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    (function () {
        const categorySelect = document.getElementById("category-select");
        const subcategorySelect = document.getElementById("subcategory-select");
        const form = document.querySelector("form");
        const actionField = document.getElementById("asset-form-action");
        const serialInput = document.getElementById("serial_number");

        function filterSubcategories() {
            const selectedCat = categorySelect.value;
            let firstShown = null;
            Array.from(subcategorySelect.options).forEach(opt => {
                if (!opt.dataset.category) {
                    return; // default option
                }
                const matches = selectedCat && opt.dataset.category === selectedCat;
                opt.hidden = !matches;
                if (matches && firstShown === null) {
                    firstShown = opt.value;
                }
            });
            // If current selection doesn't match, reset to default
            const currentOpt = subcategorySelect.options[subcategorySelect.selectedIndex];
            if (currentOpt && currentOpt.hidden) {
                subcategorySelect.value = "0";
            }
        }

        categorySelect.addEventListener("change", filterSubcategories);
        filterSubcategories();

        if (form) {
            form.addEventListener("keydown", (e) => {
                const target = e.target;

                // Prevent Enter from submitting while cursor in Serial Number
                if (e.key === "Enter" && target === serialInput) {
                    e.preventDefault();
                    return;
                }

                // Ctrl+Enter -> Save and Add New
                if (e.key === "Enter" && e.ctrlKey) {
                    e.preventDefault();
                    if (actionField) actionField.value = "add_new";
                    form.submit();
                    return;
                }

                // Plain Enter submits normally (unless textarea to allow new lines)
                if (e.key === "Enter" && target.tagName !== "TEXTAREA") {
                    if (actionField) actionField.value = "save";
                }
            });
        }

        // Wire the secondary button to set action
        document.querySelectorAll("button[data-action]").forEach(btn => {
            btn.addEventListener("click", (e) => {
                const act = btn.getAttribute("data-action");
                if (actionField) actionField.value = act;
            });
        });
    })();
</script>
{% endblock %}
