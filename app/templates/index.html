{% extends "base.html" %}

{% block title %}Dashboard - IT Inventory Management{% endblock %}

{% block content %}
<div class="row g-3">
    <div class="col-12">
        <h1 class="h3 mb-3">Dashboard</h1>
    </div>

    <!-- Stats widgets -->
    <div class="col-6 col-md-4 col-xl-2">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h2 class="h6 mb-1">Total Assets</h2>
                <p class="display-6 mb-0">{{ total_assets }}</p>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h2 class="h6 mb-1">Assigned</h2>
                <p class="display-6 mb-0 text-primary">{{ assigned_count }}</p>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h2 class="h6 mb-1">In Stock</h2>
                <p class="display-6 mb-0 text-success">{{ in_stock_count }}</p>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h2 class="h6 mb-1">Repair</h2>
                <p class="display-6 mb-0 text-warning">{{ repair_count }}</p>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h2 class="h6 mb-1">Damaged</h2>
                <p class="display-6 mb-0 text-danger">{{ damaged_count }}</p>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h2 class="h6 mb-1">Missing</h2>
                <p class="display-6 mb-0 text-secondary">{{ missing_count }}</p>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="col-12 col-xl-4">
        <div class="card shadow-sm h-100 chart-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="h6 mb-0">Category Breakdown</h2>
                </div>
                <div class="chart-wrapper">
                    <canvas id="categoryChart" height="240" width="240"></canvas>
                </div>
                {% if category_breakdown %}
                <ul class="mt-3 small list-unstyled mb-0">
                    {% for item in category_breakdown %}
                        <li class="d-flex justify-content-between">
                            <span>{{ item.name }}</span>
                            <span class="fw-bold">{{ item.count }}</span>
                        </li>
                    {% endfor %}
                </ul>
                {% else %}
                    <p class="text-muted small mb-0">No category data yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-12 col-xl-4">
        <div class="card shadow-sm h-100 chart-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="h6 mb-0">Location Breakdown</h2>
                </div>
                <div class="chart-wrapper">
                    <canvas id="locationChart" height="220" width="380"></canvas>
                </div>
                {% if location_breakdown %}
                <ul class="mt-3 small list-unstyled mb-0">
                    {% for item in location_breakdown %}
                        <li class="d-flex justify-content-between">
                            <span>{{ item.name }}</span>
                            <span class="fw-bold">{{ item.count }}</span>
                        </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-12 col-xl-4">
        <div class="card shadow-sm h-100 chart-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="h6 mb-0">Monthly Asset Movements</h2>
                </div>
                <div class="chart-wrapper">
                    <canvas id="movementChart" height="180" width="360"></canvas>
                </div>
                {% if monthly_events %}
                <ul class="mt-3 small list-unstyled mb-0">
                    {% for item in monthly_events %}
                        <li class="d-flex justify-content-between">
                            <span>{{ item.month }}</span>
                            <span class="fw-bold">{{ item.count }}</span>
                        </li>
                    {% endfor %}
                </ul>
                {% else %}
                    <p class="text-muted small mb-0">No movement data yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Assets needing attention -->
    <div class="col-12 mt-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="h6 mb-0">Assets Needing Attention</h2>
                    <a href="{{ url_for('assets.list_assets', status='repair') }}" class="small text-decoration-none">
                        View all assets
                    </a>
                </div>

                {% if attention_assets %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Sl No.</th>
                                    <th>Asset Name</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asset in attention_assets %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ asset.name }}</td>
                                    <td>{{ asset.category.name if asset.category else "-" }}</td>
                                    <td><span class="badge bg-secondary text-uppercase">{{ asset.status }}</span></td>
                                    <td>{{ asset.location.name if asset.location else "-" }}</td>
                                    <td>{{ asset.notes or "-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">
                        No assets currently require attention based on warranty, status, or missing data.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
    (() => {
        const categoryData = {{ category_breakdown|tojson }};
        const locationData = {{ location_breakdown|tojson }};
        const monthlyData = {{ monthly_events|tojson }};

        const colors = ["#22d3ee", "#f59e0b", "#10b981", "#6366f1", "#ef4444", "#a855f7", "#14b8a6", "#ec4899"];

        function shade(hex, percent) {
            const num = parseInt(hex.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (
                0x1000000 +
                (R<255?R<0?0:R:255)*0x10000 +
                (G<255?G<0?0:G:255)*0x100 +
                (B<255?B<0?0:B:255)
            ).toString(16).slice(1);
        }

        // Simple shadow plugin to give a subtle 3D lift
        const shadowPlugin = {
            id: "shadowPlugin",
            beforeDatasetsDraw(chart, args, pluginOptions) {
                const { ctx } = chart;
                ctx.save();
                const opts = pluginOptions || {};
                ctx.shadowColor = opts.shadowColor || "rgba(0,0,0,0.35)";
                ctx.shadowBlur = opts.shadowBlur || 12;
                ctx.shadowOffsetX = opts.shadowOffsetX || 4;
                ctx.shadowOffsetY = opts.shadowOffsetY || 6;
            },
            afterDatasetsDraw(chart) {
                chart.ctx.restore();
            }
        };

        Chart.register(ChartDataLabels, shadowPlugin);

        const catCtx = document.getElementById("categoryChart");
        if (catCtx && categoryData.length) {
            const totalCat = categoryData.reduce((sum, c) => sum + (c.count || 0), 0) || 1;
            const ctx2d = catCtx.getContext("2d");
            const pieColors = categoryData.map((_, idx) => {
                const base = colors[idx % colors.length];
                const grad = ctx2d.createRadialGradient(90, 90, 30, 90, 90, 120);
                grad.addColorStop(0, shade(base, 20));
                grad.addColorStop(1, shade(base, -10));
                return grad;
            });
            new Chart(catCtx, {
                type: "pie",
                data: {
                    labels: categoryData.map(c => c.name),
                    datasets: [{
                        data: categoryData.map(c => c.count),
                        backgroundColor: pieColors,
                        borderWidth: 1,
                        hoverOffset: 0
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    animations: false,
                    layout: { padding: 8 },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: false
                        },
                        shadow: { shadowColor: "rgba(0,0,0,0.22)", shadowBlur: 9, shadowOffsetX: 2, shadowOffsetY: 5 }
                    }
                }
            });
        }

        const locCtx = document.getElementById("locationChart");
        if (locCtx && locationData.length) {
            new Chart(locCtx, {
                type: "bar",
                data: {
                    labels: locationData.map(l => l.name),
                    datasets: [{
                        label: "Office-wise Asset Count",
                        data: locationData.map(l => l.count),
                        backgroundColor: "#3b82f6",
                        borderColor: "#1d4ed8",
                        borderWidth: 1.5,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    animations: {
                        x: { duration: 0 },
                        y: { duration: 0 }
                    },
                    indexAxis: "y",
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: "#94a3b8" }
                        },
                        datalabels: {
                            display: false  // keep bars clean; values shown in list below
                        },
                        shadow: { shadowColor: "rgba(0,0,0,0.35)", shadowBlur: 12, shadowOffsetX: 0, shadowOffsetY: 6 }
                    },
                    scales: {
                        x: {
                            grid: { display: true, color: "rgba(148,163,184,0.25)" },
                            title: { display: true, text: "Count", color: "#cbd5e1" },
                            ticks: { color: "#cbd5e1" }
                        },
                        y: {
                            grid: { display: false },
                            title: { display: true, text: "Location", color: "#cbd5e1" },
                            ticks: { color: "#cbd5e1" }
                        }
                    }
                }
            });
        }

        const movCtx = document.getElementById("movementChart");
        if (movCtx && monthlyData.length) {
            new Chart(movCtx, {
                type: "line",
                data: {
                    labels: monthlyData.map(m => m.month),
                    datasets: [{
                        label: "",
                        data: monthlyData.map(m => m.count),
                        borderColor: "#f59e0b",
                        backgroundColor: "rgba(245, 158, 11, 0.2)",
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: "#f59e0b"
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    animations: {
                        x: { duration: 0 },
                        y: { duration: 0 }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: false
                        },
                        shadow: { shadowColor: "rgba(0,0,0,0.25)", shadowBlur: 10, shadowOffsetX: 0, shadowOffsetY: 6 }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: { grid: { display: true } }
                    }
                }
            });
        }
    })();
</script>
{% endblock %}
{% endblock %}
